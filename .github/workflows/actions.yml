name: Github CI

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - run: echo "ðŸŽ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ðŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "ðŸ”Ž The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      
      - name: Check out repository code
        uses: actions/checkout@v5
      
      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: Install Python 3.11 dev headers
        run: |
          sudo add-apt-repository ppa:deadsnakes/ppa -y
          sudo apt-get update
          sudo apt-get install -y python3.11 python3.11-dev python3.11-venv
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy biopython pytest jupyter nbconvert nbclient pandas ipykernel
      
      - name: Install bioinformatics tools
        run: |
          sudo apt-get update
          sudo apt-get install -y wget samtools bcftools tabix bzip2 libbz2-dev libhts-dev
          
          # Install minimap2
          wget https://github.com/lh3/minimap2/releases/download/v2.26/minimap2-2.26_x64-linux.tar.bz2
          tar -xjf minimap2-2.26_x64-linux.tar.bz2
          sudo cp minimap2-2.26_x64-linux/minimap2 /usr/local/bin/
          
          # Install HapCUT2 using system htslib
          git clone --depth 1 https://github.com/vibansal/HapCUT2.git
          cd HapCUT2
          make USE_HTSLIB=system
          sudo cp build/extractHAIRS /usr/local/bin/
          sudo cp build/HAPCUT2 /usr/local/bin/
          cd ..
          
          # Verify installations
          echo "Checking tool versions..."
          minimap2 --version
          samtools --version | head -n 1
          bcftools --version | head -n 1
          which extractHAIRS && echo "extractHAIRS installed"
          which HAPCUT2 && echo "HAPCUT2 installed"
      
      - run: echo "ðŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "ðŸ–¥ï¸ The workflow is now ready to test your code on the runner."
      
      # Week 5
      - name: Week 5 - Pharmacogenomics Analysis
        run: |
          cd week5
          
          # Convert notebook to Python script temporarily for proper outputs
          jupyter nbconvert --to python code/week5.ipynb --stdout > week5_temp.py
          python week5_temp.py

          jupyter execute code/week5.ipynb --inplace

          rm week5_temp.py
          
          echo "WEEK 5 COMPLETE"
